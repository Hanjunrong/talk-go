# 23 | 基础篇：Linux 文件系统是怎么工作的？

* 磁盘为系统提供了最基本的持久化存储。

* 文件系统则在磁盘的基础上，提供了一个用来管理文件的树状结构。

## 索引节点和目录项

Linux 中一切皆文件。不仅普通的文件和目录，就连块设备、套接字、管道等，也都要通过统一的文件系统来管理。

Linux 文件系统为每个文件都分配两个数据结构:

* 索引节点 inode

索引节点是每个文件的唯一标志

* 目录项 dentry

目录项维护的正是文件系统的树状结构

目录项和索引节点的关系是多对一

![](https://static001.geekbang.org/resource/image/32/47/328d942a38230a973f11bae67307be47.png)

目录项本身就是一个内存缓存，而索引节点则是存储在磁盘中的数据

磁盘在执行文件系统格式化时，会被分成三个存储区域，超级块、索引节点区和数据块区。其中，

* 超级块，存储整个文件系统的状态。

* 索引节点区，用来存储索引节点。

* 数据块区，则用来存储文件数据。

## 虚拟文件系统

目录项、索引节点、逻辑块以及超级块，构成了 Linux 文件系统的四大基本要素。

Linux 内核在用户进程和文件系统的中间，又引入了一个抽象层，也就是虚拟文件系统 VFS（Virtual File System）。

![](https://static001.geekbang.org/resource/image/72/12/728b7b39252a1e23a7a223cdf4aa1612.png)

## 文件系统 I/O

文件读写方式的各种差异，导致 I/O 的分类多种多样。

最常见的有，缓冲与非缓冲 I/O、直接与非直接 I/O、阻塞与非阻塞 I/O、同步与异步 I/O 等

第一种，根据是否利用标准库缓存，可以把文件 I/O 分为缓冲 I/O 与非缓冲 I/O。

* 缓冲 I/O，是指利用标准库缓存来加速文件的访问，而标准库内部再通过系统调度访问文件。

* 非缓冲 I/O，是指直接通过系统调用来访问文件，不再经过标准库缓存。

第二，根据是否利用操作系统的页缓存，可以把文件 I/O 分为直接 I/O 与非直接 I/O。

* 直接 I/O，是指跳过操作系统的页缓存，直接跟文件系统交互来访问文件。

* 非直接 I/O 正好相反，文件读写时，先要经过系统的页缓存，然后再由内核或额外的系统调用，真正写入磁盘。

第三，根据应用程序是否阻塞自身运行，可以把文件 I/O 分为阻塞 I/O 和非阻塞 I/O：

* 所谓阻塞 I/O，是指应用程序执行 I/O 操作后，如果没有获得响应，就会阻塞当前线程，自然就不能执行其他任务。

* 所谓非阻塞 I/O，是指应用程序执行 I/O 操作后，不会阻塞当前的线程，可以继续执行其他的任务，随后再通过轮询或者事件通知的形式，获取调用的结果。

第四，根据是否等待响应结果，可以把文件 I/O 分为同步和异步 I/O：

* 所谓同步 I/O，是指应用程序执行 I/O 操作后，要一直等到整个 I/O 完成后，才能获得 I/O 响应。

* 所谓异步 I/O，是指应用程序执行 I/O 操作后，不用等待完成和完成后的响应，而是继续执行就可以。等到这次 I/O 完成后，响应会用事件通知的方式，告诉应用程序。

## 性能观测

### 容量


`$ df -h /dev/sda1 
Filesystem      Size  Used Avail Use% Mounted on 
/dev/sda1        29G  3.1G   26G  11% / `

 `$ df -i ` 查看索引节点的使用情况

### 缓存

free 或 vmstat，来观察页缓存的大小

实际性能分析中，使用 `slabtop`  ，来找到占用内存最多的缓存类型。

# 第四阶段总结 (6.15 - 6.21):

本阶段主要复习了内存方面的知识, 重点会对排查工作中遇到的内存泄露, 内存使用过高起到帮助,

其实在golang中内存泄漏自己之前有遇到过, 在排查手段上会比较使用pprof等工具追查到某一些函数上,

使用svg图会更加直观一些. 虽然已经有过一些排查的经历, 但还是很好奇内存与内核之间的联系,

本阶段的学习对这些疑问有了一些实质性的解答
