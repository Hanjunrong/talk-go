# 36 | 套路篇：怎么评估系统的网络性能？

## 网络基准测试

Linux网络基于TCP/IP协议栈，而不同协议层的行为显然不同，那么，在测试之前，就应该知道要评估的网络性能，究竟属于协议栈的哪一层。

## 各协议层的性能测试

### 转发性能

网络接口层和网络层：主要负责网络包的封装、寻址。由于以及发送和接收，在这两个网络协议层中，每秒可处理的网络包数PPS，就是最重要的性能指标，特别是64B小包的处理能力

可以使用hping3作为测试网络包处理能力的性能工具 pktgen：他支持更丰富的自定义选项，方便根据实际需要构造所需网络包，从而更加准确的测试出目标服务器的性能

其中pktgen作为内核线程来运行，并不会直接找到pktgen命令。需要加载pktgen内核模块后，再通过/proc文件系统来交互，下面就是pktgen启动的两个内核线程和？/proc文件系统的交互文件

pktgen在每个CPU上启动一个内核线程，并可以通过/proc/net/pktgen下面的同名文件，跟这些线程交互，而pgctrl则主要用来控制测试的开启和停止

如果 modprobe 命令执行失败，说明你的内核没有配置 CONFIG_NET_PKTGEN 选项。这就需要你配置 pktgen 内核模块（即 CONFIG_NET_PKTGEN=m）后，重新编译内核，才可以使用

Params:测试选项 Current：测试进度 Result：测试结果，包含测试所用时间、网络包数量和分片，PPS、吞吐量以及错误数

### TCP/UDP性能

使用iperf或者netperf工具，目前iperf最新版本是iperf3

其中iperf分为服务端和客户端

稍等一会后，测试结束，回到目标服务器，查看iperf报告： 最后的SUM行就是测试的胡总结果，包括测试时间、数据传输量以及带宽等，按照发送和接收，分为sender和receiver两行

### HTTP性能

常用的有ab、webbench等 下面是ab的使用示例

`$ ab -c 1000 -n 10000 http://192.168.0.30/`

## 应用负载性能

`
# -c表示并发连接数1000，-t表示线程数为2

$ wrk -c 1000 -t 2 http://192.168.0.30/
`

wrk最大的优势：内置了LuaJIT，可以用来实现复杂场景的性能测试，wrk在调用Lua脚本时，将HTTP请求分为三个阶段，即setup，running、done。
