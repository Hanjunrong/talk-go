# 综合实战篇

## 46 | 案例篇：为什么应用容器化后，启动慢了很多？

如果你在 Docker 容器中运行 Java 应用，一定要确保，在设置容器资源限制的同时，配置好 JVM 的资源选项（比如堆内存等）。当然，如果你可以升级 Java 版本，那么升级到 Java 10 ，就可以自动解决类似问题了。

当碰到容器化的应用程序性能时，你依然可以使用，我们前面讲过的各种方法来分析和定位。

* 只不过要记得，容器化后的性能分析，跟前面内容稍微有些区别，比如下面这几点。

* 容器本身通过 cgroups 进行资源隔离，所以，在分析时要考虑 cgroups 对应用程序的影响。

* 容器的文件系统、网络协议栈等跟主机隔离。虽然在容器外面，我们也可以分析容器的行为，不过有时候，进入容器的命名空间内部，可能更为方便。容器的运行可能还会依赖于其他组件，比如各种网络插件（比如 CNI）、存储插件（比如 CSI）、设备插件（比如 GPU）等，让容器的性能分析更加复杂。如果你需要分析容器性能，别忘了考虑它们对性能的影响。

## 47，48 | 案例篇：服务器总是时不时丢包，我该怎么办？

容器化后，应用程序会通过命名空间进行隔离。所以，你在分析时，不要忘了结合命名空间、cgroups、iptables 等来综合分析。比如：

* cgroups 会影响容器应用的运行；

* iptables 中的 NAT，会影响容器的网络性能；

* 叠加文件系统，会影响应用的 I/O 性能等。

![](https://static001.geekbang.org/resource/image/7d/1b/7d8cb9a2ce1c3bad4d74f46a632f671b.png)

![](https://static001.geekbang.org/resource/image/dd/fd/dd5b4050d555b1c23362456e357dfffd.png)

从图中你可以看出，可能发生丢包的位置，实际上贯穿了整个网络协议栈。换句话说，全程都有丢包的可能。比如我们从下往上看：

* 在两台 VM 连接之间，可能会发生传输失败的错误，比如网络拥塞、线路错误等；

* 在网卡收包后，环形缓冲区可能会因为溢出而丢包；

* 在链路层，可能会因为网络帧校验失败、QoS 等而丢包；

* 在 IP 层，可能会因为路由失败、组包大小超过 MTU 等而丢包；

* 在传输层，可能会因为端口未监听、资源占用超过内核限制等而丢包；

* 在套接字层，可能会因为套接字缓冲区溢出而丢包；

* 在应用层，可能会因为应用程序异常而丢包；

* 此外，如果配置了 iptables 规则，这些网络包也可能因为 iptables 过滤规则而丢包。

网络丢包，通常会带来严重的性能下降，特别是对 TCP 来说，丢包通常意味着网络拥塞和重传，进一步还会导致网络延迟增大、吞吐降低。

## 49 | 案例篇：内核线程 CPU 利用率太高，我该怎么办？

## 50，51 | 案例篇：动态追踪怎么用？
